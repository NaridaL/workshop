(self.webpackChunkworkshop=self.webpackChunkworkshop||[]).push([[376],{3376:(t,r,e)=>{"use strict";e.d(r,{mN:()=>tt,Co:()=>F,M4:()=>it,uK:()=>b,wU:()=>h,bE:()=>o,Fw:()=>$,PI:()=>n,gc:()=>s,yu:()=>H,V:()=>X,V3:()=>B,zy:()=>z,Nv:()=>T,hS:()=>q,qC:()=>O,hu:()=>c,yP:()=>a,nY:()=>_,OD:()=>m,J8:()=>V,uZ:()=>v,en:()=>j,p3:()=>y,t7:()=>f,hO:()=>Z,At:()=>M,Tw:()=>R,AW:()=>N});class i{constructor(){this[Symbol.toStringTag]="Map",this._map=new Map,this._size=0}toString(){return"{"+Array.from(this.entries2()).map((({key:t,value:r})=>t+":"+r)).join(", ")+"}"}forEach(t,r){for(const e of this._map.values())for(const{key:i,value:n}of e)t.call(r,n,i,this)}*keys(){for(const t of this._map.values())for(const{key:r}of t)yield r}*values(){for(const t of this._map.values())for(const{value:r}of t)yield r}[Symbol.iterator](){return this.entries()}set(t,r){return this.set2(t,r),this}set2(t,r){const e=t.hashCode(),i=this._map.get(e);if(i){const e=i.findIndex((r=>r.key.equals(t)));if(-1!=e)return i[e].value=r,!1;i.push({key:t,value:r})}else this._map.set(e,[{key:t,value:r}]);return this._size++,!0}has(t){const r=t.hashCode(),e=this._map.get(r);return void 0!==e&&e.some((r=>r.key.equals(t)))}get(t){const r=t.hashCode(),e=this._map.get(r),i=e&&e.find((r=>r.key.equals(t)));return i&&i.value}getLike(t){for(const r of t.hashCodes()){const e=this._map.get(r),i=e&&e.find((r=>r.key.like(t)));if(i)return i}}setLike(t,r){return!this.getLike(t)&&this.set(t,r)}delete(t){const r=t.hashCode(),e=this._map.get(r);if(e){const i=e.findIndex((r=>r.key.equals(t)));if(-1!=i)return 1==e.length?this._map.delete(r):e.splice(i,1),this._size--,!0}return!1}deleteLike(t){for(const r of t.hashCodes()){const e=this._map.get(r);if(e){const i=e.findIndex((r=>r.key.like(t)));if(-1!=i){const t=e[i];return 1==e.length?this._map.delete(r):e.splice(i,1),this._size--,t}}}}*entries2(){for(const t of this._map.values())yield*t}*entries(){for(const t of this._map.values())for(const{key:r,value:e}of t)yield[r,e]}clear(){this._map.clear(),this._size=0}get size(){return this._size}}const n=Math.PI,s=2*n,h=!1,o=1/(1<<26);function a(t,...r){var e,i;if(h)for(let n=0;n<r.length;n++)if(!(r[n]instanceof t))throw Error("assertInst objs["+n+"] is not a "+t.prototype.name+". "+(null===(i=null===(e=r[n])||void 0===e?void 0:e.constructor)||void 0===i?void 0:i.name)+r[n]);return!0}function l(...t){if(h)for(let r=0;r<t.length;r++)if("number"!=typeof t[r])throw Error(`assertNumbers arguments[${r}] is not a number. ${typeof t[r]} == typeof ${t[r]}`);return!0}function u(...t){if(h)for(let r=0;r<t.length;r++)if("number"!=typeof t[r]||t[r]%1!=0)throw Error(`assertNumbers arguments[${r}] is not an int. ${typeof t[r]} == typeof ${t[r]}`);return!0}function c(t,...r){if(h&&!t)throw Error("assert failed: "+r.map((t=>"function"==typeof t?t():t||"")).join("\n"));return!0}function m(t,...r){if(h&&!t())throw Error("assertf failed: "+t.toString()+r.map((t=>"function"==typeof t?t():t||"")).join("\n"))}function f(t,r,e){return t*(1-e)+r*e}console.log("NLA_PRECISION",1/(1<<26)),console.log("NLA_DEBUG",h);const d=Number.prototype.toString;Number.prototype.toString=function(t){return n==this?"PI":d.call(this,t)};const y=(t,r=1/(1<<26))=>Math.abs(t)<=r,g=(t,r,e=1/(1<<26))=>Math.abs(t-r)<=e,w=(t,r,e=1/(1<<26))=>t-r<-e,p=g;function x(t,r,e){if(void 0===e||0==+e)return t(r);if(e=+e,isNaN(r=+r)||"number"!=typeof e||e%1!=0)return NaN;let i=r.toString().split("e");return i=(r=t(+(i[0]+"e"+(i[1]?+i[1]-e:-e)))).toString().split("e"),+(i[0]+"e"+(i[1]?+i[1]+e:e))}const M=x.bind(void 0,Math.round);function v(t,r,e){return l(t,r,e),Math.max(r,Math.min(e,t))}function z(t,r,...e){Object.getOwnPropertyNames(r).forEach((i=>{e.includes(i)||(t.hasOwnProperty(i)&&console.warn("target ",t," already has property ",i,t[i]),Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(r,i)))}))}x.bind(void 0,Math.floor),x.bind(void 0,Math.ceil);let A=t=>t;const b=(t,r)=>t-r;function S(t){return~~(t*(1<<28))}const F=.017453292519943295;function k(t){switch(typeof t){case"undefined":return"undefined";case"function":return t.toString();case"number":return""+t;case"string":return JSON.stringify(t);case"object":return null==t?"null":t.sce;default:throw Error()}}function E(t,...r){return t+"("+r.map(k).join(",")+")"}function O(t,r,e){const i=t[r];t[r]=t[e],t[e]=i}function P(t,r,e,i,n){for(u(r,i,n),i+=n,n+=r;n-- >r;)e[--i]=t[n];return e}function I(t,r,e,i,n,s,h){let o=r+h*e,a=n+h*s;for(;o>r;)i[a-=s]=t[o-=e]}function q(t,r,e=1){l(t,e);const i=Math.ceil((r-t)/e),n=Array(i);for(let r=t,s=0;s<i;r+=e,s++)n[s]=r;return n}function T(t,r){l(t),c("function"==typeof r);const e=Array(t);let i=t;for(;i--;)e[i]=r(i,t);return e}function N(t,r){let e,i=t.length,n=-1/0;for(;i--;){const s=t[i],h=r(s,i,t);h>n&&(n=h,e=s)}return e}function j(t,r){return t[r%t.length]}function Y(t){let r=t.length,e=-1/0;for(;r--;){const i=t[r];e<i&&(e=i)}return e}function R(t){const r=new Set(t);return Array.from(r)}function V(t,r){const e=t[r];return r==t.length-1?t.pop():t[r]=t.pop(),e}function Z(t,r){if(r.sort(((t,r)=>t-r)),0===r.length)return t;if(1===r.length)return t.splice(r[0],1),t;let e=r[0],i=r[0],n=0;for(let s=r[0];s<t.length;s++)if(s!==i)t[e++]=t[s];else{if(n++,!(n<r.length))return t.splice(e,s+1-e),t;i=r[n]}throw Error("illegal state")}Object.map=function(t,r,e){const i={};for(const n in t)i[n]=r.call(e,t[n],n,t);return i},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.equals=function(t){return this==t},Object.defineProperty(Object.prototype,"sce",{get:function(){return this.toSource()}}),Object.defineProperty(Object.prototype,"str",{get:function(){return this.toString()}});class B{constructor(t,r,e){this.x=t,this.y=r,this.z=e,l(t,r,e)}static random(){return new B(Math.random(),Math.random(),Math.random())}static parallel(t,r){return t.dot(r)-t.length()*r.length()}static randomUnit(){const t=2*Math.random()*Math.PI,r=2*Math.random()-1,e=Math.sqrt(1-Math.pow(r,2));return new B(e*Math.cos(t),e*Math.sin(t),r)}static fromAngles(t,r){throw Error()}static fromFunction(t){return new B(t(0),t(1),t(2))}static min(t,r){return new B(Math.min(t.x,r.x),Math.min(t.y,r.y),Math.min(t.z,r.z))}static max(t,r){return new B(Math.max(t.x,r.x),Math.max(t.y,r.y),Math.max(t.z,r.z))}static lerp(t,r,e){return new B(t.x*(1-e)+r.x*e,t.y*(1-e)+r.y*e,t.z*(1-e)+r.z*e)}static fromArray(t){return new B(t[0],t[1],t[2])}static angleBetween(t,r){return t.angleTo(r)}static zip(t,...r){return c(t instanceof Function),new B(t.apply(void 0,r.map((t=>t.x))),t.apply(void 0,r.map((t=>t.y))),t.apply(void 0,r.map((t=>t.z))))}static normalOnPoints(t,r,e){return _(t,r,e),t.to(r).cross(t.to(e))}static add(...t){_(...t);let r=0,e=0,i=0,n=t.length;for(;n--;)r+=t[n].x,e+=t[n].y,i+=t[n].z;return new B(r,e,i)}static sub(...t){_(...t);let r=t[0].x,e=t[0].y,i=t[0].z,n=t.length;for(;n--;)r-=t[n].x,e-=t[n].y,i-=t[n].z;return new B(r,e,i)}static pack(t,r,e=0,i=0,n=t.length-e){const s=r||new Float32Array(3*n);c(s.length-i>=3*n,"dest.length - destStart >= v3count * 3",s.length,i,3*n);let h=n,o=e,a=i;for(;h--;){const r=t[o++];s[a++]=r.x,s[a++]=r.y,s[a++]=r.z}return s}static unpack(t,r,e=0,i=0,n=(t.length-e)/3){c((r=r||Array(n)).length-i>=n,"dest.length - destStart >= v3count");let s=n,h=e,o=i;for(;s--;)r[o++]=new B(t[h++],t[h++],t[h++]);return r}static packXY(t,r,e=0,i=0,n=t.length-e){const s=r||new Float32Array(2*n);c(s.length-i>=n,"dest.length - destStart >= v3count");let h=n,o=e,a=i;for(;h--;){const r=t[o++];s[a++]=r.x,s[a++]=r.y}return s}static unpackXY(t,r,e=0,i=0,n=Math.min(t.length/2,r&&r.length||1/0)-i){c((r=r||Array(n)).length-i>=n,"dest.length - destStart >= v3count"),c(t.length-e>=2*n,"dest.length - destStart >= v3count");let s=n,h=e,o=i;for(;s--;)r[o++]=new B(t[h++],t[h++],0);return r}static perturbed(t,r){return t.perturbed(r)}static polar(t,r,e=0){return new B(t*Math.cos(r),t*Math.sin(r),e)}static sphere(t,r,e=1){return new B(e*Math.cos(r)*Math.cos(t),e*Math.cos(r)*Math.sin(t),e*Math.sin(r))}static inverseLerp(t,r,e){const i=t.to(r);return t.to(e).dot(i)/i.squared()}get 0(){return this.x}get 1(){return this.y}get 2(){return this.z}get u(){return this.x}get v(){return this.y}perturbed(t=1/(1<<26)*.8){return this.map((r=>r+(Math.random()-.5)*t))}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}e(t){return c(t>=0&&t<3),0==t?this.x:1==t?this.y:this.z}negated(){return new B(-this.x,-this.y,-this.z)}abs(){return new B(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}plus(t){return _(t),new B(this.x+t.x,this.y+t.y,this.z+t.z)}schur(t){return new B(this.x*t.x,this.y*t.y,this.z*t.z)}divv(t){return new B(this.x/t.x,this.y/t.y,this.z/t.z)}minus(t){return _(t),new B(this.x-t.x,this.y-t.y,this.z-t.z)}to(t){return _(t),t.minus(this)}times(t){return l(t),new B(this.x*t,this.y*t,this.z*t)}div(t){return l(t),new B(this.x/t,this.y/t,this.z/t)}dot(t){return a(B,t),this.x*t.x+this.y*t.y+this.z*t.z}lerp(t,r){return _(t),l(r),B.lerp(this,t,r)}squared(){return this.dot(this)}distanceTo(t){return _(t),Math.hypot(this.x-t.x,this.y-t.y,this.z-t.z)}distanceToSquared(t){return _(t),this.minus(t).squared()}toSource(){return B.NAMEMAP.get(this)||this.toString()}nonParallelVector(){const t=this.abs();return t.x<=t.y&&t.x<=t.z?B.X:t.y<=t.x&&t.y<=t.z?B.Y:B.Z}slerp(t,r){_(t),l(r);const e=Math.sin,i=this.angleTo(t);return this.times(e((1-r)*i)/e(i)).plus(t.times(e(r*i)/e(i)))}min(t){return new B(Math.min(this.x,t.x),Math.min(this.y,t.y),Math.min(this.z,t.z))}max(t){return new B(Math.max(this.x,t.x),Math.max(this.y,t.y),Math.max(this.z,t.z))}equals(t){return this==t||this.x==t.x&&this.y==t.y&&this.z==t.z}cross(t){return new B(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}minElement(){return Math.min(this.x,this.y,this.z)}maxElement(){return Math.max(this.x,this.y,this.z)}toArray(t=3){return[this.x,this.y,this.z].slice(0,t)}getPerpendicular(){if(y(this.x)&&y(this.y)){if(y(this.z))throw Error("zero vector");return B.Y}return new B(-this.y,this.x,0)}dim(){return 3}els(){return[this.x,this.y,this.z]}angleXY(){return Math.atan2(this.y,this.x)}lengthXY(){return Math.hypot(this.x,this.y)}squaredXY(){return this.x*this.x+this.y*this.y}xy(){return new B(this.x,this.y,0)}map(t){return new B(t(this.x,"x"),t(this.y,"y"),t(this.z,"z"))}toString(t){return t=t||A,B.NAMEMAP.get(this)||"V("+[this.x,this.y,this.z].map(t).join(", ")+")"}angleTo(t){return c(1==arguments.length),_(t),c(!this.likeO()),c(!t.likeO()),Math.acos(Math.min(1,this.dot(t)/this.length()/t.length()))}angleRelativeNormal(t,r){return c(2==arguments.length),_(t,r),m((()=>r.hasLength(1))),Math.atan2(this.cross(t).dot(r),this.dot(t))}isParallelTo(t){_(t),c(!this.likeO()),c(!t.likeO());const r=this.dot(t);return g(this.squared()*t.squared(),r*r)}isPerpendicularTo(t){return _(t),c(!this.likeO(),"!this.likeO()"),c(!t.likeO(),"!vector.likeO()"),y(this.dot(t))}isReverseDirTo(t){_(t),c(!this.likeO()),c(!t.likeO());const r=this.dot(t);return g(Math.sqrt(this.squared()*t.squared()),r)}length(){return Math.hypot(this.x,this.y,this.z)}likeO(){return this.like(B.O)}like(t){return t===this||t instanceof B&&g(this.x,t.x)&&g(this.y,t.y)&&g(this.z,t.z)}likeOrReversed(t){return g(Math.abs(this.dot(t)),Math.sqrt(this.squared()*t.squared()))}unit(){return c(!this.likeO(),"cannot normalize zero vector"),this.div(this.length())}normalized(){throw Error("documentation stub. use .unit()")}toLength(t){return l(t),this.times(t/this.length())}projectedOn(t){return _(t),t.times(this.dot(t)/t.dot(t))}rejectedFrom(t){return _(t),this.minus(t.times(this.dot(t)/t.dot(t)))}rejectedFrom1(t){return _(t),c(t.hasLength(1)),this.minus(t.times(this.dot(t)))}rejectedLength(t){return _(t),Math.sqrt(this.dot(this)-Math.pow(this.dot(t),2)/t.dot(t))}rejected1Length(t){return _(t),c(t.hasLength(1)),Math.sqrt(this.dot(this)-Math.pow(this.dot(t),2))}hasLength(t){return l(t),g(t,this.length())}absSum(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}minAbsElement(){return Math.min(Math.abs(this.x),Math.abs(this.y),Math.min(this.z))}maxAbsElement(){return Math.max(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}maxAbsDim(){const t=Math.abs(this.x),r=Math.abs(this.y),e=Math.abs(this.z);return t>=r?t>=e?0:2:r>=e?1:2}minAbsDim(){const t=Math.abs(this.x),r=Math.abs(this.y),e=Math.abs(this.z);return t<r?t<e?0:2:r<e?1:2}withElement(t,r){return c(["x","y","z"].includes(t),""+t),l(r),"x"==t?new B(r,this.y,this.z):"y"==t?new B(this.x,r,this.z):new B(this.x,this.y,r)}hashCode(){function t(t){return~~(t*(1<<28))}return~~(31*(31*t(this.x)+t(this.y))+t(this.z))}hashCodes(){const t=~~(31*(31*~~(this.x*(1<<28)-.5)+~~(this.y*(1<<28)-.5))+~~(this.z*(1<<28)-.5));return[~~t,~~(t+961),~~(t+31),~~(t+31+961),~~(t+1),~~(t+1+961),~~(t+1+31),~~(t+1+31+961)]}compareTo(t){return this.x!=t.x?this.x-t.x:this.y!=t.y?this.y-t.y:this.z-t.z}compareTo2(t,r=1/(1<<26)){return p(this.x,t.x,r)?p(this.y,t.y,r)?p(this.z,t.z,r)?0:this.z-t.z:this.y-t.y:this.x-t.x}toAngles(){return{theta:Math.atan2(this.y,this.x),phi:Math.asin(this.z/this.length())}}}function X(t,r,e){if(3==arguments.length)return new B(parseFloat(t),parseFloat(r),parseFloat(e));if(2==arguments.length)return new B(parseFloat(t),parseFloat(r),0);if(1==arguments.length&&"object"==typeof t){if(t instanceof B)return t;if(t instanceof Array||t instanceof Float32Array||t instanceof Float64Array){if(2==t.length)return new B(parseFloat(t[0]),parseFloat(t[1]),0);if(3==t.length)return new B(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))}else if("x"in t&&"y"in t)return new B(parseFloat(t.x),parseFloat(t.y),"z"in t?parseFloat(t.z):0)}throw Error("invalid arguments"+arguments)}B.O=new B(0,0,0),B.X=new B(1,0,0),B.Y=new B(0,1,0),B.Z=new B(0,0,1),B.XY=new B(1,1,0),B.XYZ=new B(1,1,1),B.INF=new B(1/0,1/0,1/0),B.UNITS=[B.X,B.Y,B.Z],B.NAMEMAP=(new i).set(B.O,"V3.O").set(B.X,"V3.X").set(B.Y,"V3.Y").set(B.Z,"V3.Z").set(B.XYZ,"V3.XYZ").set(B.INF,"V3.INF");class L{constructor(t){this.v=t,a(Float64Array,t)}static fromFunction(t,r){l(t);const e=new Float64Array(t);let i=t;for(;i--;)e[i]=r(i);return new L(e)}static random(t){return L.fromFunction(t,(t=>Math.random()))}static from(...t){return c(t[0]instanceof Float64Array||t.every((t=>"number"==typeof t)),'args[0] instanceof Float64Array || args.every(a => "number" == typeof a)'),new L(t[0]instanceof Float64Array?t[0]:Float64Array.from(t))}static Zero(t){l(t);let r=0;const e=new Float64Array(t);for(;r--;)e[r]=0;return new L(e)}static Unit(t,r){l(t,r);let e=0;const i=new Float64Array(t);for(;e--;)i[e]=+(e==r);return new L(i)}static pack(t,r,e=0,i=0,n=t.length-e){const s=t[0].dim(),h=r||new Float32Array(s*n);c(h.length-i>=n*s,"dest.length - destStart >= v3count * 3",h.length,i,3*n);let o=n,a=e,l=i;for(;o--;){const r=t[a++];for(let t=0;t<s;t++)h[l++]=r.v[t]}return h}static lerp(t,r,e){c(t.dim()==r.dim());const i=new Float64Array(t.v.length);let n=t.v.length;for(;n--;)i[n]=t.v[n]*(1-e)+r.v[n]*e;return new L(i)}static add(...t){const r=t[0].v.length,e=new Float64Array(r);let i=t.length;for(;i--;){let n=r;for(;n--;)e[n]+=t[i].v[n]}return new L(e)}static fromV3AndWeight(t,r){return new L(new Float64Array([t.x*r,t.y*r,t.z*r,r]))}get x(){return this.v[0]}get y(){return this.v[1]}get z(){return this.v[2]}get w(){return this.v[3]}[Symbol.iterator](){return this.v[Symbol.iterator]()}dim(){return this.v.length}e(t){if(0>t||t>=this.v.length)throw Error("array index out of bounds");return this.v[t]}plus(t){const r=this.v,e=t.v,i=new Float64Array(r.length);let n=r.length;for(;n--;)i[n]=r[n]+e[n];return new L(i)}minus(t){const r=this.v,e=t.v,i=new Float64Array(r.length);let n=r.length;for(;n--;)i[n]=r[n]-e[n];return new L(i)}times(t){const r=this.v,e=new Float64Array(r.length);let i=r.length;for(;i--;)e[i]=r[i]*t;return new L(e)}div(t){const r=this.v,e=new Float64Array(r.length);let i=r.length;for(;i--;)e[i]=r[i]/t;return new L(e)}dot(t){c(this.dim==t.dim,"passed vector must have the same dim");let r=0;const e=this.v,i=t.v;let n=e.length;for(;n--;)r+=e[n]*i[n];return r}cross(t){a(L,t);const r=new Float64Array(3);return r[0]=this.v[1]*t.v[2]-this.v[2]*t.v[1],r[1]=this.v[2]*t.v[0]-this.v[0]*t.v[2],r[2]=this.v[0]*t.v[1]-this.v[1]*t.v[0],new L(r)}schur(t){a(L,t);const r=this.v,e=t.v,i=new Float64Array(r.length);let n=r.length;for(;n--;)i[n]=r[n]*e[n];return new L(i)}equals(t){if(t===this)return!0;if(t.constructor!==L)return!1;if(this.v.length!=t.v.length)return!1;let r=this.v.length;for(;r--;)if(this.v[r]!==t.v[r])return!1;return!0}like(t){if(t===this)return!0;if(t.constructor!==L)return!1;if(this.v.length!=t.v.length)return!1;let r=this.v.length;for(;r--;)if(!g(this.v[r],t.v[r]))return!1;return!0}map(t){return new L(this.v.map(t))}toString(t){return t=t||(t=>+t.toFixed(6)),"Vector("+this.v.map(t).join(", ")+")"}toSource(){return E("VV",...this.v)}angleTo(t){return a(L,t),c(!this.isZero(),"!this.likeO()"),c(!t.isZero(),"!vector.likeO()"),Math.acos(v(this.dot(t)/this.length()/t.length(),-1,1))}isParallelTo(t){return a(L,t),c(!this.isZero(),"!this.likeO()"),c(!t.isZero(),"!vector.likeO()"),g(Math.sqrt(this.lengthSquared()*t.lengthSquared()),Math.abs(this.dot(t)))}isPerpendicularTo(t){return a(L,t),c(!this.isZero(),"!this.likeO()"),c(!t.isZero(),"!vector.likeO()"),y(this.dot(t))}isZero(){return y(this.length())}length(){return Math.hypot.apply(void 0,this.v)}lengthSquared(){let t=0;const r=this.v;let e=r.length;for(;e--;)t+=r[e]*r[e];return t}unit(){const t=this.length();if(y(t))throw Error("cannot normalize zero vector");return this.div(this.length())}normalized(){throw Error("documentation stub. use .unit()")}asRowMatrix(){return new U(this.v.length,1,this.v)}asColMatrix(){return new U(1,this.v.length,this.v)}projectedOn(t){return a(L,t),t.times(this.dot(t)/t.dot(t))}rejectedOn(t){return a(L,t),this.minus(t.times(this.dot(t)/t.dot(t)))}to(t){return t.minus(this)}hasLength(t){return l(t),g(t,this.length())}V3(){return new B(this.v[0],this.v[1],this.v[2])}p3(){c(4==this.v.length);const t=this.v[3];return new B(this.v[0]/t,this.v[1]/t,this.v[2]/t)}transposed(){return new U(this.v.length,1,this.v)}}function C(...t){return new L(new Float64Array(t))}class U{constructor(t,r,e){this.width=t,this.height=r,this.m=e,u(t,r),m((()=>0<t)),m((()=>0<r)),c(t*r==e.length,"width * height == m.length",t,r,e.length)}static random(t,r){return U.fromFunction(t,r,(()=>Math.random()))}static fromFunction(t,r,e){const i=new Float64Array(r*t);let n=r*t;for(;n--;)i[n]=e(Math.floor(n/t),n%t,n);return new U(t,r,i)}static identityN(t){u(t);const r=new Float64Array(t*t);let e=t*(t+1);for(;e;)e-=t+1,r[e]=1;return new U(t,t,r)}static permutation(t,r,e){u(t,r,e),m((()=>0<=r&&r<t)),m((()=>0<=e&&e<t));const i=new Float64Array(t*t);let n=t*(t+1);for(;n;)n-=t+1,i[n]=1;return i[r*t+r]=0,i[e*t+e]=0,i[r*t+e]=1,i[e*t+r]=1,new U(t,t,i)}static fromRowArrays(...t){if(0==t.length)throw Error("cannot have 0 vector");const r=t.length,e=t[0].length,i=new Float64Array(r*e);P(t[0],0,i,0,e);for(let n=1;n<r;n++){if(t[n].length!=e)throw Error("all row arrays must be the same length");P(t[n],0,i,n*e,e)}return this.new(e,r,i)}static fromColVectors(t){return U.fromColArrays(...t.map((t=>t.v)))}static forWidthHeight(t,r){return new U(t,r,new Float64Array(t*r))}static fromColArrays(...t){if(0==t.length)throw Error("cannot have 0 vector");const r=t.length,e=t[0].length,i=new Float64Array(e*r);I(t[0],0,1,i,0,r,e);for(let n=1;n<r;n++){if(t[n].length!=e)throw Error("all col arrays must be the same length");I(t[n],0,1,i,n,r,e)}return this.new(r,e,i)}static product(...t){const[r,e]=Array.isArray(t[0])?[t[0],t[1]]:[t,void 0];if(0==r.length)throw Error("Can't guess matrix size.");return 1==r.length?U.copy(r[0],e):U.copy(r.reduce(((t,r)=>t.times(r))),e)}static jacobi(t,r,e=t(r),i=1e-6){const n=U.forWidthHeight(r.length,e.length);for(let s=0;s<r.length;s++){r[s]+=i;const h=t(r);for(let t=0;t<e.length;t++){const r=(h[t]-e[t])/i;n.setEl(t,s,r)}r[s]-=i}return n}static copy(t,r=t.new()){a(U,t,r),c(t.width==r.width),c(t.height==r.height),c(r!=t,"result != src");const e=t.m,i=r.m;let n=e.length;for(;n--;)i[n]=e[n];return r}static new(t,r,e){return new U(t,r,e)}copy(){return U.copy(this)}e(t,r){return u(t,r),c(0<=t&&t<this.height,"rowIndex out of bounds "+t),c(0<=r&&r<this.width,"colIndex out of bounds "+r),this.m[t*this.width+r]}setEl(t,r,e){u(t,r),c(0<=t&&t<this.height,"rowIndex out of bounds "+t),c(0<=r&&r<this.width,"colIndex out of bounds "+r),l(e),this.m[t*this.width+r]=e}plus(t){c(this.width==t.width),c(this.height==t.height);const r=this.new();let e=this.m.length;for(;e--;)r.m[e]=this.m[e]+t.m[e];return r}minus(t){c(this.width==t.width),c(this.height==t.height);const r=this.new();let e=this.m.length;for(;e--;)r.m[e]=this.m[e]-t.m[e];return r}mulScalar(t){l(t);const r=this.new();let e=this.m.length;for(;e--;)r.m[e]=this.m[e]*t;return r}divScalar(t){l(t);const r=this.new();let e=this.m.length;for(;e--;)r.m[e]=this.m[e]/t;return r}new(){return new U(this.width,this.height,new Float64Array(this.width*this.height))}toString(t,r,e){c("string"==typeof(t=t||(t=>t.toFixed(6)))(0),typeof t(0)),c(!r||r.length==this.width),c(!e||e.length==this.height);const i=Array.from(this.m).map(t),n=T(this.height,(t=>i.slice(t*this.width,(t+1)*this.width)));r&&n.unshift(Array.from(r)),e&&n.forEach(((t,i)=>t.unshift(e[i-(r?1:0)]||"")));const s=T(this.width,(t=>Y(n.map((r=>r[t].length)))));return n.map(((t,i)=>t.map(((t,n)=>(0==i&&r||0==n&&e?String.prototype.padEnd:String.prototype.padStart).call(t,s[n]))).join("  "))).map((t=>t+"\n")).join("")}row(t){u(t),c(0<=t&&t<this.height,"rowIndex out of bounds "+t);const r=new Float64Array(this.width);return P(this.m,t*this.width,r,0,this.width),new L(r)}col(t){u(t),c(0<=t&&t<this.width,"colIndex out of bounds "+t);const r=new Float64Array(this.height);return I(this.m,t,this.width,r,0,1,this.height),new L(r)}dim(){return{width:this.width,height:this.height}}dimString(){return this.width+"x"+this.height}equals(t){if(t.constructor!=this.constructor)return!1;if(this.width!=t.width||this.height!=t.height)return!1;let r=this.m.length;for(;r--;)if(this.m[r]!=t.m[r])return!1;return!0}equalsMatrix(t,r=1/(1<<26)){if(a(U,t),this.width!=t.width||this.height!=t.height)return!1;let e=this.m.length;for(;e--;)if(Math.abs(this.m[e]-t.m[e])>=r)return!1;return!0}hashCode(){let t=0,r=this.m.length;for(;r--;)t=31*t+S(this.m[r]);return t}isZero(){let t=this.m.length;for(;t--;)if(!y(this.m[t]))return!1;return!0}isOrthogonal(){return this.isSquare()&&this.transposed().times(this).equalsMatrix(U.identityN(this.width))}luDecomposition(){m((()=>this.isSquare()),this.dim().toSource());const t=this.width,r=this.asRowArrays(Float64Array),e=T(t,(r=>new Float64Array(t))),i=U.identityN(t).asRowArrays(Float64Array);let n=0;for(let s=0;s<t;s++){let h=0,o=-1,a=0;for(let e=n;e<t;e++){const t=r[e][s];a+=+(0!=t),Math.abs(t)>h&&(h=Math.abs(t),o=e)}if(0!=h){if(c(-1!==o),O(r,n,o),O(e,n,o),O(i,n,o),e[s][s]=1,1<a)for(let i=n+1;i<t;i++){const h=r[i][s]/r[n][s];e[i][s]=h;for(let e=s;e<t;e++)r[i][e]-=h*r[n][e]}n++}}return{L:U.fromRowArrays(...e),U:U.fromRowArrays(...r),P:U.fromRowArrays(...i)}}gauss(){const t=this.width,r=this.height,e=this.asRowArrays(Float64Array),i=T(r,(r=>new Float64Array(t))),n=U.identityN(r).asRowArrays(Float64Array);let s=0;for(let h=0;h<t;h++){let o=0,a=-1,l=0;for(let t=s;t<r;t++){const r=e[t][h];l+=+(0!=r),Math.abs(r)>o&&(o=Math.abs(r),a=t)}if(0!=o){if(c(-1!==a),O(e,s,a),O(i,s,a),O(n,s,a),i[s][h]=1,1<l)for(let n=s+1;n<r;n++){const r=e[n][h]/e[s][h];i[n][h]=r;for(let i=h;i<t;i++)e[n][i]-=r*e[s][i]}s++}}return{L:U.fromRowArrays(...i),U:U.fromRowArrays(...e),P:U.fromRowArrays(...n)}}qrDecompositionGivensRotation(){const t=this.copy();function r(t,r,e,i,n){const s=U.identityN(t);return s.setEl(r,r,i),s.setEl(e,e,i),s.setEl(r,e,n),s.setEl(e,r,-n),s}let e=U.identityN(this.height);for(let i=0;i<this.width;i++)for(let n=i+1;n<this.height;n++){const s=t.e(i,i),h=t.e(n,i);if(0==h)continue;const o=Math.hypot(s,h),a=s/o,l=h/o;for(let r=i;r<this.width;r++){const e=t.e(i,r)*a+t.e(n,r)*l,s=t.e(n,r)*a-t.e(i,r)*l;t.setEl(i,r,e),t.setEl(n,r,s)}e=r(this.height,i,n,a,l).times(e)}return{Q:e.transposed(),R:t}}isPermutation(){return!(!this.isSquare()||this.m.some((t=>!y(t)&&!g(1,t)))||this.asRowArrays(Array).some((t=>1!=t.filter((t=>g(1,t))).length))||this.asColArrays(Array).some((t=>1!=t.filter((t=>g(1,t))).length)))}isDiagonal(t){let r=this.m.length;for(;r--;)if(0!=r%(this.width+1)&&!y(this.m[r]))return!1;return!0}isIdentity(t){return this.isLowerUnitriangular(t)&&this.isUpperTriangular(t)}isUpperTriangular(t=1/(1<<26)){if(!this.isSquare())return!1;for(let r=1;r<this.height;r++)for(let e=0;e<r;e++)if(!y(this.m[r*this.width+e],t))return!1;return!0}isSymmetric(t=1/(1<<26)){if(!this.isSquare())return!1;for(let r=0;r<this.height-1;r++)for(let e=r+1;e<this.width;e++){const i=this.m[r*this.width+e],n=this.m[e*this.width+r];if(!g(i,n,t))return!1}return!0}solveLinearSystem(t){a(L,t);const{L:r,U:e,P:i}=this.luDecomposition(),n=r.solveForwards(i.timesVector(t));return e.solveBackwards(n)}isLowerUnitriangular(t=1/(1<<26)){if(!this.isSquare())return!1;for(let r=0;r<this.height-1;r++)for(let e=r;e<this.width;e++){const i=this.m[r*this.width+e];if(r==e?!g(1,i,t):!y(i,t))return!1}return!0}isLowerTriangular(t=1/(1<<26)){if(!this.isSquare())return!1;for(let r=0;r<this.height-1;r++)for(let e=r+1;e<this.width;e++)if(!y(this.m[r*this.width+e],t))return!1;return!0}solveBackwards(t){_(t),c(this.height==t.dim(),"this.height == x.dim()"),c(this.isUpperTriangular(),"this.isUpperTriangular()\n"+this.str);const r=new Float64Array(this.width);let e=this.height;for(;e--;){let i=t.v[e];for(let t=e+1;t<this.width;t++)i-=r[t]*this.e(e,t);r[e]=i/this.e(e,e)}return new L(r)}solveBackwardsMatrix(t){const r=Array(t.width);let e=t.width;for(;e--;)r[e]=this.solveBackwards(t.col(e));return U.fromColVectors(r)}solveForwardsMatrix(t){const r=Array(t.width);let e=t.width;for(;e--;)r[e]=this.solveForwards(t.col(e));return U.fromColVectors(r)}solveForwards(t){_(t),c(this.height==t.dim(),"this.height == x.dim()"),m((()=>this.isLowerTriangular()),this.toString());const r=new Float64Array(this.width);for(let e=0;e<this.height;e++){let i=t.v[e];for(let t=0;t<e;t++)i-=r[t]*this.e(e,t);r[e]=i/this.e(e,e)}return new L(r)}rank(){const t=this.gauss().U;let r=this.height;for(;r--&&t.row(r).isZero(););return r+1}rowsIndependent(){return this.height==this.rank()}colsIndependent(){return this.width==this.rank()}asRowArrays(t=Float64Array){return T(this.height,(r=>this.rowArray(r,t)))}asColArrays(t=Float64Array){return T(this.width,(r=>this.colArray(r,t)))}rowArray(t,r=Float64Array){const e=new r(this.width);return P(this.m,t*this.width,e,0,this.width)}colArray(t,r=Float64Array){const e=new r(this.width);return I(this.m,t,this.height,e,0,1,this.height),e}subMatrix(t,r,e,i){c(0<t&&0<r&&0<e&&0<i),c(t+r<=this.width&&e+i<=this.height);const n=new Float64Array(r*i);return function(t,r,e,i,n,s,h,o){for(let n=0;n<o;n++)P(t,r+e*n,i,0+s*n,h)}(this.m,t,this.width,n,0,r,i,r),new U(r,i,n)}map(t){return new U(this.width,this.height,this.m.map(t))}dimEquals(t){return a(U,t),this.width==t.width&&this.height==t.height}inversed(){if(this.isSquare()){if(2==this.width)return this.inversed2();if(3==this.width)return this.inversed3();if(4==this.width)return this.inversed4()}const{L:t,U:r,P:e}=this.luDecomposition(),i=t.solveForwardsMatrix(e);return r.solveBackwardsMatrix(i)}inversed2(){m((()=>2==this.width&&2==this.height));const t=U.forWidthHeight(2,2),r=this.m,e=t.m,i=r[0]*r[3]-r[1]*e[2];return e[0]=r[3]/i,e[1]=-r[2]/i,e[2]=-r[1]/i,e[3]=r[0]/i,t}inversed3(t=U.forWidthHeight(3,3)){a(U,t),m((()=>3==this.width&&3==this.height)),m((()=>3==t.width&&3==t.height)),c((()=>this!=t));const r=this.m,e=t.m;e[0]=r[4]*r[8]-r[5]*r[7],e[1]=-r[1]*r[8]+r[2]*r[7],e[2]=r[1]*r[5]-r[2]*r[4],e[3]=-r[3]*r[8]+r[5]*r[6],e[4]=r[0]*r[8]-r[2]*r[6],e[5]=-r[0]*r[5]+r[2]*r[3],e[6]=r[3]*r[7]-r[4]*r[6],e[7]=-r[0]*r[7]+r[1]*r[6],e[8]=r[0]*r[4]-r[1]*r[3];const i=r[0]*e[0]+r[1]*e[3]+r[2]*e[6];let n=9;for(;n--;)e[n]/=i;return t}inversed4(t=U.forWidthHeight(4,4)){a(U,t),m((()=>4==this.width&&4==this.height)),m((()=>4==t.width&&4==t.height)),c((()=>this!=t));const r=this.m,e=t.m;e[0]=r[5]*r[10]*r[15]-r[5]*r[14]*r[11]-r[6]*r[9]*r[15]+r[6]*r[13]*r[11]+r[7]*r[9]*r[14]-r[7]*r[13]*r[10],e[1]=-r[1]*r[10]*r[15]+r[1]*r[14]*r[11]+r[2]*r[9]*r[15]-r[2]*r[13]*r[11]-r[3]*r[9]*r[14]+r[3]*r[13]*r[10],e[2]=r[1]*r[6]*r[15]-r[1]*r[14]*r[7]-r[2]*r[5]*r[15]+r[2]*r[13]*r[7]+r[3]*r[5]*r[14]-r[3]*r[13]*r[6],e[3]=-r[1]*r[6]*r[11]+r[1]*r[10]*r[7]+r[2]*r[5]*r[11]-r[2]*r[9]*r[7]-r[3]*r[5]*r[10]+r[3]*r[9]*r[6],e[4]=-r[4]*r[10]*r[15]+r[4]*r[14]*r[11]+r[6]*r[8]*r[15]-r[6]*r[12]*r[11]-r[7]*r[8]*r[14]+r[7]*r[12]*r[10],e[5]=r[0]*r[10]*r[15]-r[0]*r[14]*r[11]-r[2]*r[8]*r[15]+r[2]*r[12]*r[11]+r[3]*r[8]*r[14]-r[3]*r[12]*r[10],e[6]=-r[0]*r[6]*r[15]+r[0]*r[14]*r[7]+r[2]*r[4]*r[15]-r[2]*r[12]*r[7]-r[3]*r[4]*r[14]+r[3]*r[12]*r[6],e[7]=r[0]*r[6]*r[11]-r[0]*r[10]*r[7]-r[2]*r[4]*r[11]+r[2]*r[8]*r[7]+r[3]*r[4]*r[10]-r[3]*r[8]*r[6],e[8]=r[4]*r[9]*r[15]-r[4]*r[13]*r[11]-r[5]*r[8]*r[15]+r[5]*r[12]*r[11]+r[7]*r[8]*r[13]-r[7]*r[12]*r[9],e[9]=-r[0]*r[9]*r[15]+r[0]*r[13]*r[11]+r[1]*r[8]*r[15]-r[1]*r[12]*r[11]-r[3]*r[8]*r[13]+r[3]*r[12]*r[9],e[10]=r[0]*r[5]*r[15]-r[0]*r[13]*r[7]-r[1]*r[4]*r[15]+r[1]*r[12]*r[7]+r[3]*r[4]*r[13]-r[3]*r[12]*r[5],e[11]=-r[0]*r[5]*r[11]+r[0]*r[9]*r[7]+r[1]*r[4]*r[11]-r[1]*r[8]*r[7]-r[3]*r[4]*r[9]+r[3]*r[8]*r[5],e[12]=-r[4]*r[9]*r[14]+r[4]*r[13]*r[10]+r[5]*r[8]*r[14]-r[5]*r[12]*r[10]-r[6]*r[8]*r[13]+r[6]*r[12]*r[9],e[13]=r[0]*r[9]*r[14]-r[0]*r[13]*r[10]-r[1]*r[8]*r[14]+r[1]*r[12]*r[10]+r[2]*r[8]*r[13]-r[2]*r[12]*r[9],e[14]=-r[0]*r[5]*r[14]+r[0]*r[13]*r[6]+r[1]*r[4]*r[14]-r[1]*r[12]*r[6]-r[2]*r[4]*r[13]+r[2]*r[12]*r[5],e[15]=r[0]*r[5]*r[10]-r[0]*r[9]*r[6]-r[1]*r[4]*r[10]+r[1]*r[8]*r[6]+r[2]*r[4]*r[9]-r[2]*r[8]*r[5];const i=r[0]*e[0]+r[1]*e[4]+r[2]*e[8]+r[3]*e[12];let n=16;for(;n--;)e[n]/=i;return t}canMultiply(t){return a(U,t),this.width==t.height}times(t){a(U,t),c(this.canMultiply(t),"Cannot multiply this {this.dimString()} by matrix {matrix.dimString()}");const r=t.width,e=this.height,i=this.width,n=new Float64Array(r*e);let s=e;for(;s--;){let e=r;for(;e--;){let h=0,o=i;for(;o--;)h+=this.m[s*i+o]*t.m[o*r+e];n[s*r+e]=h}}return new U(r,e,n)}timesVector(t){_(t),c(this.width==t.dim());const r=this.height,e=this.width,i=new Float64Array(r);let n=r;for(;n--;){let r=0,s=e;for(;s--;)r+=this.m[n*e+s]*t.v[s];i[n]=r}return new L(i)}transposed(){const t=this.height,r=this.width,e=new Float64Array(t*r);let i=r;for(;i--;){let n=t;for(;n--;)e[i*t+n]=this.m[n*r+i]}return new U(t,r,e)}transpose(){const t=this.height,r=this.width,e=this.m;let i=t;for(;i--;){let n=Math.min(i,r);for(;n--;){const s=e[i*r+n];e[i*r+n]=e[n*t+i],e[n*t+i]=s}}this.width=t,this.height=r}isSquare(){return this.height==this.width}diagonal(){if(!this.isSquare())throw Error("!!");const t=new Float64Array(this.width);let r=this.width*(this.width+1),e=this.width;for(;e--;)r-=this.width+1,t[e]=this.m[r];return new L(t)}maxEl(){return Math.max.apply(void 0,this.m)}minEl(){return Math.min.apply(void 0,this.m)}maxAbsColSum(){let t=0,r=this.width;for(;r--;){let e=0,i=this.height;for(;i--;)e+=Math.abs(this.m[i*this.width+r]);t=Math.max(t,e)}return t}maxAbsRowSum(){let t=0,r=this.height;for(;r--;){let e=0,i=this.width;for(;i--;)e+=Math.abs(this.m[r*this.width+i]);t=Math.max(t,e)}return t}getTriangularDeterminant(){c(this.isUpperTriangular()||this.isLowerTriangular(),"not a triangular matrix");let t=1,r=this.width*(this.width+1);for(;r;)r-=this.width+1,t*=this.m[r];return t}getDeterminant(){return this.luDecomposition().U.getTriangularDeterminant()}hasFullRank(){return Math.min(this.width,this.height)==this.rank()}permutationAsIndexMap(){m((()=>this.isPermutation()));const t=Array(this.height);let r=this.height;for(;r--;){const e=r*this.width;let i=e;for(;this.m[i]<.5;)i++;t[r]=i-e}return t}getDependentRowIndexes(t=this.gauss()){const{L:r,U:e,P:i}=t,n=Array(this.height);let s=this.height;for(;s--&&e.row(s).length()<1/(1<<26);)n[s]=!0;let h=this.height;for(;h--;)if(n[h]){let t=Math.min(h,this.width);for(;t--;)0!==r.e(h,t)&&(n[t]=!0)}console.log("m\n",this.toString((t=>""+t))),console.log("L\n",r.toString((t=>""+t))),console.log("U\n",e.toString((t=>""+t))),console.log("P\n",i.toString((t=>""+t)));const o=i.permutationAsIndexMap();return n.map(((t,r)=>t&&o[r])).filter((t=>null!=t))}lerp(t,r,e=this.new()){a(U,t,e),l(r),c(this.width==t.width&&this.height==t.height);const i=1-r;let n=this.m.length;for(;n--;)e.m[n]=i*this.m[n]+r*t.m[n];return e}}function _(...t){if(h)for(let t=0;t<arguments.length;t++)if(!(arguments[t]instanceof B||arguments[t]instanceof L))throw Error("assertVectors arguments["+t+"] is not a vector. "+typeof arguments[t]+" == typeof "+arguments[t]);return!0}const D={normal1:B.X,w:0},$={normal1:B.Y,w:0},W={normal1:B.Z,w:0};class H{mirror(t){return this.transform(it.mirror(t))}mirroredX(){return this.mirror(D)}mirrorY(){return this.mirror($)}mirrorZ(){return this.mirror(W)}project(t){return this.transform(it.project(t))}projectXY(){return this.transform(it.project(W))}projectYZ(){return this.transform(it.project(D))}projectZX(){return this.transform(it.project($))}translate(...t){return this.transform(it.translate.apply(void 0,t),E(".translate",...t))}scale(...t){return this.transform(it.scale.apply(void 0,t),E(".scale",...t))}rotateX(t){return this.transform(it.rotateX(t),`.rotateX(${t})`)}rotateY(t){return this.transform(it.rotateY(t),`.rotateY(${t})`)}rotateZ(t){return this.transform(it.rotateZ(t),`.rotateZ(${t})`)}rotate(t,r,e){return this.transform(it.rotateLine(t,r,e),E(".rotate",t,r,e))}rotateAB(t,r){return this.transform(it.rotateAB(t,r),E(".rotateAB",t,r))}eulerZXZ(t,r,e){throw Error()}shearX(t,r){return this.transform(new it([1,t,r,0,0,1,0,0,0,0,1,0,0,0,0,1]))}foo(){return this.transform(it.FOO)}bar(){return this.transform(it.BAR)}visit(t,...r){let e=Object.getPrototypeOf(this);for(;!t.hasOwnProperty(e.constructor.name)&&e!==H.prototype;)e=Object.getPrototypeOf(e);if(t.hasOwnProperty(e.constructor.name))return t[e.constructor.name].apply(this,r);throw Error("No implementation for "+this.constructor.name)}}const J=/^(abstract|boolean|break|byte|case|catch|char|class|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throw|throws|transient|true|try|typeof|undefined|var|void|volatile|while|with)$/,G=[];function K(t,r=0){return void 0===t?"undefined":null===t?"null":t.toSource()}function Q(t,r){t.prototype.toSource||Object.defineProperty(t.prototype,"toSource",{value:r,writable:!0,configurable:!0,enumerable:!1})}Q(Boolean,Boolean.prototype.toString),Q(Function,Function.prototype.toString),Q(Number,Number.prototype.toString),Q(RegExp,RegExp.prototype.toString),Q(Date,(function(){return"new Date("+this.getTime()+")"})),Q(String,(function(){return JSON.stringify(this)})),Q(Array,(function(){if(G.includes(this))return"CIRCULAR_REFERENCE";G.push(this);let t="[";for(let r=0;r<this.length;r++)t+="\n\t"+K(this[r]).replace(/\r\n|\n|\r/g,"$&\t"),r!==this.length-1&&(t+=",");return t+=0===this.length?"]":"\n]",G.pop(),t})),Q(Object,(function(){if(G.includes(this))return"CIRCULAR_REFERENCE";G.push(this);let t="{";const r=Object.keys(this).sort();for(let i=0;i<r.length;i++){const n=r[i];t+="\n\t"+(/^[a-z_$][0-9a-z_$]*$/gi.test(e=n)&&!J.test(e)?n:JSON.stringify(n))+": "+K(this[n]).replace(/\r\n|\n|\r/g,"$&\t"),i!==r.length-1&&(t+=",")}var e;return t+=0===r.length?"}":"\n}",G.pop(),t}));class tt extends H{constructor(t=B.INF,r=B.INF.negated()){super(),this.min=t,this.max=r,_(t,r)}static forXYZ(t,r,e){return new tt(B.O,new B(t,r,e))}static forAABBs(t){const r=new tt;for(const e of t)r.addAABB(e);return r}addPoint(t){return _(t),this.min=this.min.min(t),this.max=this.max.max(t),this}addPoints(t){return t.forEach((t=>this.addPoint(t))),this}addAABB(t){return a(tt,t),this.addPoint(t.min),this.addPoint(t.max),this}withoutAABB(t){let r,e;a(tt,t);const i=this.volume(),n=this.size();let s=-1/0;for(let h=0;h<3;h++){const o=["x","y","z"][h],a=t.min[o]-this.min[o]>this.max[o]-t.max[o],l=a?this.min[o]:Math.max(this.min[o],t.max[o]),u=a?Math.min(this.max[o],t.min[o]):this.max[o],c=(u-l)*i/n[o];c>s&&(s=c,r=this.min.withElement(o,l),e=this.max.withElement(o,u))}return new tt(r,e)}getIntersectionAABB(t){return a(tt,t),new tt(this.min.max(t.min),this.max.min(t.max))}touchesAABB(t){return a(tt,t),!(this.min.x>t.max.x||this.max.x<t.min.x||this.min.y>t.max.y||this.max.y<t.min.y||this.min.z>t.max.z||this.max.z<t.min.z)}touchesAABBfuzzy(t,r=1/(1<<26)){return a(tt,t),!(w(t.max.x,this.min.x,r)||w(this.max.x,t.min.x,r)||w(t.max.y,this.min.y,r)||w(this.max.y,t.min.y,r)||w(t.max.z,this.min.z,r)||w(this.max.z,t.min.z,r))}intersectsAABB(t){return a(tt,t),!(this.min.x>=t.max.x||this.max.x<=t.min.x||this.min.y>=t.max.y||this.max.y<=t.min.y||this.min.z>=t.max.z||this.max.z<=t.min.z)}intersectsAABB2d(t){return a(tt,t),!(this.min.x>=t.max.x||this.max.x<=t.min.x||this.min.y>=t.max.y||this.max.y<=t.min.y)}containsPoint(t){return _(t),this.min.x<=t.x&&this.min.y<=t.y&&this.min.z<=t.z&&this.max.x>=t.x&&this.max.y>=t.y&&this.max.z>=t.z}containsSphere(t,r){return _(t),l(r),this.distanceToPoint(t)>r}intersectsSphere(t,r){return _(t),l(r),this.distanceToPoint(t)<=r}distanceToPoint(t){_(t);const r=t.x,e=t.y,i=t.z,n=this.min,s=this.max;return this.containsPoint(t)?Math.max(n.x-r,r-s.x,n.y-e,e-s.y,n.z-i,i-s.z):t.distanceTo(new B(v(r,n.x,s.x),v(e,n.y,s.y),v(i,n.z,s.z)))}containsAABB(t){return a(tt,t),this.containsPoint(t.min)&&this.containsPoint(t.max)}likeAABB(t){return a(tt,t),this.min.like(t.min)&&this.max.like(t.max)}intersectsLine(t){_(t.anchor,t.dir1);const r=t.dir1.map((t=>t||5e-324)),e=this.min.minus(t.anchor).divv(r),i=this.max.minus(t.anchor).divv(r),n=e.min(i).maxElement(),s=e.max(i).minElement();return n<=s&&!(s<t.tMin||t.tMax<n)}hasVolume(){return this.min.x<=this.max.x&&this.min.y<=this.max.y&&this.min.z<=this.max.z}volume(){if(!this.hasVolume())return-1;const t=this.max.minus(this.min);return t.x*t.y*t.z}size(){return this.max.minus(this.min)}getCenter(){return this.min.plus(this.max).div(2)}transform(t){a(it,t),c(t.isAxisAligned());const r=new tt;return r.addPoint(t.transformPoint(this.min)),r.addPoint(t.transformPoint(this.max)),r}ofTransformed(t){a(it,t);const r=new tt;return r.addPoints(t.transformedPoints(this.corners())),r}corners(){const t=this.min,r=this.max;return[t,new B(t.x,t.y,r.z),new B(t.x,r.y,t.z),new B(t.x,r.y,r.z),new B(r.x,t.y,t.z),new B(r.x,t.y,r.z),new B(r.x,r.y,t.z),r]}toString(){return E("new AABB",this.min,this.max)}toSource(){return this.toString()}getM4(){return it.translate(this.min).times(it.scale(this.size()))}}const{PI:rt,abs:et}=Math;class it extends U{constructor(...t){let r;if(0==arguments.length)r=new Float64Array(16);else{const t=Array.prototype.concat.apply([],arguments);c(16==t.length,"flattened.length == 16 "+t.length),r=new Float64Array(t)}super(4,4,r)}static inverse(t,r=new it){return t.inversed4(r)}static permutation4(t,r,e=new it){u(t,r),m((()=>0<=t&&t<4)),m((()=>0<=r&&r<4));const i=e.m;return it.identity(e),i[4*t+t]=0,i[4*r+r]=0,i[4*t+r]=1,i[4*r+t]=1,e}static transpose(t,r=new it){a(it,t),a(it,r),c(t!=r,"matrix != result");const e=t.m,i=r.m;return i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15],r}static multiply(t,r,e=new it){a(it,t,r),a(it,e),c(t!=e,"left != result"),c(r!=e,"right != result");const i=t.m,n=r.m,s=e.m;return s[0]=i[0]*n[0]+i[1]*n[4]+(i[2]*n[8]+i[3]*n[12]),s[1]=i[0]*n[1]+i[1]*n[5]+(i[2]*n[9]+i[3]*n[13]),s[2]=i[0]*n[2]+i[1]*n[6]+(i[2]*n[10]+i[3]*n[14]),s[3]=i[0]*n[3]+i[1]*n[7]+(i[2]*n[11]+i[3]*n[15]),s[4]=i[4]*n[0]+i[5]*n[4]+(i[6]*n[8]+i[7]*n[12]),s[5]=i[4]*n[1]+i[5]*n[5]+(i[6]*n[9]+i[7]*n[13]),s[6]=i[4]*n[2]+i[5]*n[6]+(i[6]*n[10]+i[7]*n[14]),s[7]=i[4]*n[3]+i[5]*n[7]+(i[6]*n[11]+i[7]*n[15]),s[8]=i[8]*n[0]+i[9]*n[4]+(i[10]*n[8]+i[11]*n[12]),s[9]=i[8]*n[1]+i[9]*n[5]+(i[10]*n[9]+i[11]*n[13]),s[10]=i[8]*n[2]+i[9]*n[6]+(i[10]*n[10]+i[11]*n[14]),s[11]=i[8]*n[3]+i[9]*n[7]+(i[10]*n[11]+i[11]*n[15]),s[12]=i[12]*n[0]+i[13]*n[4]+(i[14]*n[8]+i[15]*n[12]),s[13]=i[12]*n[1]+i[13]*n[5]+(i[14]*n[9]+i[15]*n[13]),s[14]=i[12]*n[2]+i[13]*n[6]+(i[14]*n[10]+i[15]*n[14]),s[15]=i[12]*n[3]+i[13]*n[7]+(i[14]*n[11]+i[15]*n[15]),e}static product(...t){const[r,e]=Array.isArray(t[0])?[t[0],t[1]]:[t,new it];if(0==r.length)return it.identity(e);if(1==r.length)return it.copy(r[0],e);if(2==r.length)return it.multiply(r[0],r[1],e);let i=it.temp0,n=it.temp1;it.multiply(r[0],r[1],i);for(let t=2;t<r.length-1;t++)it.multiply(i,r[t],n),[i,n]=[n,i];return it.multiply(i,r.last,e)}static forSys(t,r,e=t.cross(r),i=B.O){return _(t,r,e,i),new it(t.x,r.x,e.x,i.x,t.y,r.y,e.y,i.y,t.z,r.z,e.z,i.z,0,0,0,1)}static forRows(t,r,e,i=B.O){return _(t,r,e,i),new it(t.x,t.y,t.z,0,r.x,r.y,r.z,0,e.x,e.y,e.z,0,i.x,i.y,i.z,1)}static identity(t=new it){a(it,t);const r=t.m;return r[0]=r[5]=r[10]=r[15]=1,r[1]=r[2]=r[3]=r[4]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,t}static fromFunction4(t,r=new it){c("function"==typeof t),a(it,r);const e=r.m;let i=16;for(;i--;)e[i]=t(Math.floor(i/4),i%4,i);return r}static perspective(t,r,e,i,n=new it){return it.perspectiveRad(t*F,r,e,i,n)}static perspectiveRad(t,r,e,i,n=new it){a(it,n),l(t,r,e,i);const s=Math.tan(t/2)*e,h=s*r;return it.frustum(-h,h,-s,s,e,i,n)}static perspectivePlane(t,r=new it){a(it,r);const e=r.m;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t.normal1.x,e[13]=t.normal1.y,e[14]=t.normal1.z,e[15]=-t.w,r}static frustum(t,r,e,i,n,s,h=new it){l(t,r,e,i,n,s),c(0<n,"0 < near"),c(n<s,"near < far"),a(it,h);const o=h.m;return o[0]=2*n/(r-t),o[1]=0,o[2]=(r+t)/(r-t),o[3]=0,o[4]=0,o[5]=2*n/(i-e),o[6]=(i+e)/(i-e),o[7]=0,o[8]=0,o[9]=0,o[10]=-(s+n)/(s-n),o[11]=-2*s*n/(s-n),o[12]=0,o[13]=0,o[14]=-1,o[15]=0,h}static projectPlanePoint(t,r,e=new it){_(t,r.normal1),a(it,e);const i=e.m,n=r.normal1,s=r.w,h=n.dot(t);return i[0]=t.x*n.x+s-h,i[1]=t.x*n.y,i[2]=t.x*n.z,i[3]=-s*t.x,i[4]=t.y*n.x,i[5]=t.y*n.y+s-h,i[6]=t.y*n.z,i[7]=-s*t.y,i[8]=t.z*n.x,i[9]=t.z*n.y,i[10]=t.z*n.z+s-h,i[11]=-s*t.z,i[12]=n.x,i[13]=n.y,i[14]=n.z,i[15]=-h,e}static ortho(t,r,e,i,n,s,h=new it){l(t,r,e,i,n,s),a(it,h);const o=h.m;return o[0]=2/(r-t),o[1]=0,o[2]=0,o[3]=-(r+t)/(r-t),o[4]=0,o[5]=2/(i-e),o[6]=0,o[7]=-(i+e)/(i-e),o[8]=0,o[9]=0,o[10]=-2/(s-n),o[11]=-(s+n)/(s-n),o[12]=0,o[13]=0,o[14]=0,o[15]=1,h}static scale(...t){let r,e,i,n;t[0]instanceof B?(c(t.length<=2),({x:r,y:e,z:i}=t[0]),n=t[1]):"number"!=typeof t[1]?(r=e=i=t[0],n=t[1]):(c(t.length<=4),r=t[0],e=t[1],i=null!=t[2]?t[2]:1,n=t[3]),null==n&&(n=new it),a(it,n),l(r,e,i);const s=n.m;return s[0]=r,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,n}static translate(...t){let r,e,i,n;t[0]instanceof B?(c(t.length<=2),({x:r,y:e,z:i}=t[0]),n=t[1]):(c(t.length<=4),r=t[0],e=null!=t[1]?t[1]:0,i=null!=t[2]?t[2]:0,n=t[3]),null==n&&(n=new it),a(it,n),l(r,e,i);const s=n.m;return s[0]=1,s[1]=0,s[2]=0,s[3]=r,s[4]=0,s[5]=1,s[6]=0,s[7]=e,s[8]=0,s[9]=0,s[10]=1,s[11]=i,s[12]=0,s[13]=0,s[14]=0,s[15]=1,n}static rotate(t,r,e){null==e&&(e=new it),a(it,e);let{x:i,y:n,z:s}=r;c(!new B(i,n,s).likeO(),"!V(x, y, z).likeO()");const h=e.m,o=Math.sqrt(i*i+n*n+s*s);i/=o,n/=o,s/=o;const l=Math.cos(t),u=Math.sin(t),m=1-l;return h[0]=i*i*m+l,h[1]=i*n*m-s*u,h[2]=i*s*m+n*u,h[3]=0,h[4]=n*i*m+s*u,h[5]=n*n*m+l,h[6]=n*s*m-i*u,h[7]=0,h[8]=s*i*m-n*u,h[9]=s*n*m+i*u,h[10]=s*s*m+l,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,e}static lookAt(t,r,e,i=new it){_(t,r,e),a(it,i);const n=i.m,s=t.minus(r).unit(),h=e.cross(s).unit(),o=s.cross(h).unit();return n[0]=h.x,n[1]=h.y,n[2]=h.z,n[3]=-h.dot(t),n[4]=o.x,n[5]=o.y,n[6]=o.z,n[7]=-o.dot(t),n[8]=s.x,n[9]=s.y,n[10]=s.z,n[11]=-s.dot(t),n[12]=0,n[13]=0,n[14]=0,n[15]=1,i}static rotateX(t){l(t);const r=Math.sin(t),e=Math.cos(t);return new it([1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1])}static rotateY(t){const r=Math.sin(t),e=Math.cos(t);return new it([e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1])}static rotateZ(t){const r=Math.sin(t),e=Math.cos(t);return new it([e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1])}static rotateAB(t,r,e=new it){_(t,r),a(it,e);const i=t.cross(r),n=i.length();if(y(n))return it.identity(e);const s=Math.atan2(n,t.dot(r));return it.rotateLine(B.O,i,s,e)}static rotateLine(t,r,e,i=new it){_(t,r),l(e),a(it,i),r=r.unit();const n=t.x,s=t.y,h=t.z,o=r.x,u=r.y,c=r.z,m=i.m,f=Math.cos(e),d=Math.sin(e);return m[0]=o*o+(u*u+c*c)*f,m[1]=o*u*(1-f)-c*d,m[2]=o*c*(1-f)+u*d,m[3]=(n*(u*u+c*c)-o*(s*u+h*c))*(1-f)+(s*c-h*u)*d,m[4]=o*u*(1-f)+c*d,m[5]=u*u+(o*o+c*c)*f,m[6]=u*c*(1-f)-o*d,m[7]=(s*(o*o+c*c)-u*(n*o+h*c))*(1-f)+(h*o-n*c)*d,m[8]=o*c*(1-f)-u*d,m[9]=u*c*(1-f)+o*d,m[10]=c*c+(o*o+u*u)*f,m[11]=(h*(o*o+u*u)-c*(n*o+s*u))*(1-f)+(n*u-s*o)*d,m[12]=0,m[13]=0,m[14]=0,m[15]=1,i}static mirror(t,r=new it){_(t.normal1),a(it,r);const[e,i,n]=t.normal1,s=t.w,h=r.m;return h[0]=1-2*e*e,h[1]=-2*i*e,h[2]=-2*n*e,h[3]=2*e*s,h[4]=-2*e*i,h[5]=1-2*i*i,h[6]=-2*n*i,h[7]=2*i*s,h[8]=-2*e*n,h[9]=-2*i*n,h[10]=1-2*n*n,h[11]=2*n*s,h[12]=0,h[13]=0,h[14]=0,h[15]=1,r}static project(t,r=t.normal1,e=new it){_(r,t.normal1),a(it,e);const i=t.w,n=e.m,s=t.normal1.dot(r),{x:h,y:o,z:l}=t.normal1,{x:u,y:c,z:m}=r.div(s);return n[0]=1-h*u,n[1]=-o*u,n[2]=-l*u,n[3]=u*i,n[4]=-h*c,n[5]=1-o*c,n[6]=-l*c,n[7]=c*i,n[8]=-h*m,n[9]=-o*m,n[10]=1-l*m,n[11]=m*i,n[12]=0,n[13]=0,n[14]=0,n[15]=1,e}static lineProjection(t,r=new it){_(t.anchor,t.dir1),a(it,r);const e=t.anchor.x,i=t.anchor.y,n=t.anchor.z,s=t.dir1.x,h=t.dir1.y,o=t.dir1.z,l=r.m;return l[0]=s*s,l[1]=s*h,l[2]=s*o,l[3]=e,l[4]=h*s,l[5]=h*h,l[6]=h*o,l[7]=i,l[8]=o*s,l[9]=o*h,l[10]=o*o,l[11]=n,l[12]=0,l[13]=0,l[14]=0,l[15]=1,r}static pointInversion(t,r=new it){_(t),a(it,r);const e=r.m;return e[0]=-1,e[1]=0,e[2]=0,e[3]=2*t.x,e[4]=0,e[5]=-1,e[6]=0,e[7]=2*t.y,e[8]=0,e[9]=0,e[10]=-1,e[11]=2*t.z,e[12]=0,e[13]=0,e[14]=0,e[15]=1,r}static new(t,r,e){return c(4==t&&4==r),new it(...e)}get X(){return this.transformVector(B.X)}get Y(){return this.transformVector(B.Y)}get Z(){return this.transformVector(B.Z)}get O(){return this.getTranslation()}isMirror(t=1/(1<<26)){const r=this.m,e=Math.sqrt((1-r[0])/2),i=Math.sqrt((1-r[5])/2),n=Math.sqrt((1-r[10])/2);return g(r[1],-2*i*e,t)&&g(r[2],-2*n*e,t)&&g(r[4],-2*e*i,t)&&g(r[6],-2*n*i,t)&&g(r[8],-2*e*n,t)&&g(r[9],-2*i*n,t)&&g(r[12],0,t)&&g(r[13],0,t)&&g(r[14],0,t)&&g(r[15],1,t)&&g(r[3]*i,r[7]*e,t)&&g(r[7]*n,r[11]*i,t)&&g(r[11]*e,r[3]*n,t)}inversed(t){return it.inverse(this,t)}trace(){return this.m[0]+this.m[5]+this.m[10]+this.m[15]}as3x3(t){const r=(t=it.copy(this,t)).m;return r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,t}transform(t){return t.times(this)}realEigenValues3(){const t=this.m;c(0==t[12]&&0==t[13]&&0==t[14]);const[r,e,i,,n,s,h,,o,a,l]=t,u=r+s+l,m=-r*s-r*l+e*n+i*o-s*l+h*a,f=r*(s*l-h*a)-e*(n*l-h*o)+i*(n*a-s*o);return console.log(-1,u,m,f),function(t,r,e,i){if(y(t))return y(r)?[-i/e]:function(t,r){const e=t*t/4-r;if(e<-1/(1<<26))return[];if(e<=1/(1<<26))return[-t/2];{const r=Math.sqrt(e);return[-t/2-r,-t/2+r]}}(e/r,i/r);const n=t;t=r/n;const s=(3*(r=e/n)-t*t)/3/3,h=s*s*s,o=(2*t*t*t-9*t*r+27*(e=i/n))/27,a=o/2,l=a*a+h;if(l<-1/(1<<26)/8){const r=Math.sqrt(-h),e=-o/(2*r),i=Math.acos(e<-1?-1:e>1?1:e),n=2*Math.cbrt(r);return[n*Math.cos(i/3)-t/3,n*Math.cos((i+2*Math.PI)/3)-t/3,n*Math.cos((i+4*Math.PI)/3)-t/3]}if(l<=1/(1<<26)/8){if(0==a)return[-t/3];const r=a<0?Math.cbrt(-a):-Math.cbrt(a);return[2*r-t/3,-r-t/3]}{const r=Math.sqrt(l);return[Math.cbrt(-a+r)-Math.cbrt(a+r)-t/3]}}(-1,u,m,f)}realEigenVectors3(){const t=this.realEigenValues3(),r=this.times(it.IDENTITY3);console.log(this.toString()),console.log(r.toString());let e=t.map((t=>it.IDENTITY3.scale(-t).plus(r)));if(console.log(e.map((t=>t.determinant3()))),console.log(e.map((t=>""+t.toString((t=>""+t)))).join("\n\n")),console.log(e.map((t=>""+t.gauss().U.toString((t=>""+t)))).join("\n\n")),console.log("mats.map(m=>m.rank())",e.map((t=>t.rank()))),1==t.length)return console.log(e[0].toString()),m((()=>0==e[0].rank())),T(3,(t=>new B(this.m[t],this.m[4+t],this.m[8+t])));if(2==t.length){1==e[0].rank()&&(e=[e[1],e[0]]),m((()=>2==e[0].rank())),m((()=>1==e[1].rank()));const t=e[0].gauss().U,r=t.row(0).cross(t.row(1)).V3().unit(),i=e[1].gauss().U.row(0).V3(),n=i.getPerpendicular().unit(),s=r.cross(n).rejectedFrom(i);return[r,n,s]}if(3==t.length)return e.forEach(((t,r)=>c(2==t.rank(),r+": "+t.rank()))),e.map((t=>{const r=t.gauss().U;return r.row(0).cross(r.row(1)).V3().unit()}));throw Error("there cannot be more than 3 eigen values")}svd3(){function t(t,r,e,i){const n=it.identity();return n.setEl(t,t,e),n.setEl(r,r,e),n.setEl(t,r,i),n.setEl(r,t,-i),n}const r=this.as3x3();let e=r.transposed().times(r),i=it.identity();console.log(e.str);for(let n=0;n<16;n++){console.log("blahg\n",i.times(e).times(i.transposed()).str),c(i.times(e).times(i.transposed()).likeM4(r.transposed().times(r)),i.times(e).times(i.transposed()).str,r.transposed().times(r).str);let n=0,s=1,h=10;for(;h--;){const t=Math.abs(e.m[h]);h%4!=Math.floor(h/4)&&t>n&&(n=t,s=h)}const o=Math.floor(s/4),a=s%4,l=e.m[5*o],u=e.m[5*a],m=e.m[s],f=l===u?rt/4:Math.atan(2*m/(l-u))/2;console.log(s,o,a,"phi",f);const d=t(o,a,Math.cos(f),-Math.sin(f));c(d.transposed().times(d).likeIdentity()),console.log(d.str),i=i.times(d),e=it.product(d.transposed(),e,d),console.log(e.str)}const n=e.map(((t,r)=>r%5==0?Math.sqrt(t):0));return{U:it.product(r,i,n.map(((t,r)=>r%5==0?1/t:0))),SIGMA:n,VSTAR:i.transposed()}}map(t){return it.fromFunction4(((r,e,i)=>t(this.m[i],i,this.m)))}likeM4(t){return a(it,t),this.m.every(((r,e)=>g(r,t.m[e])))}transposed(t){return it.transpose(this,t)}times(t){return it.multiply(this,t)}vanishingPoint(t){_(t);const r=this.m,e=t.x,i=t.y,n=t.z,s=e*r[12]+i*r[13]+n*r[14];if(y(s))return;const h=e*r[0]+i*r[1]+n*r[2],o=e*r[4]+i*r[5]+n*r[6],a=e*r[8]+i*r[9]+n*r[10];return new B(h/s,o/s,a/s)}transformPoint(t){_(t);const r=this.m,e=t.x,i=t.y,n=t.z,s=e*r[0]+i*r[1]+n*r[2]+r[3],h=e*r[4]+i*r[5]+n*r[6]+r[7],o=e*r[8]+i*r[9]+n*r[10]+r[11],a=e*r[12]+i*r[13]+n*r[14]+r[15];return new B(s/a,h/a,o/a)}transformVector(t,r=!0){_(t);const e=this.m,i=t.x*e[12]+t.y*e[13]+t.z*e[14];return r&&c(y(i),(()=>"w === 0 needs to be true for this to make sense (w ="+i+this.str)),new B(e[0]*t.x+e[1]*t.y+e[2]*t.z,e[4]*t.x+e[5]*t.y+e[6]*t.z,e[8]*t.x+e[9]*t.y+e[10]*t.z)}transformVector2(t,r){_(t,r);const e=this.timesVector(C(r.x,r.y,r.z,1)),i=this.timesVector(C(t.x,t.y,t.z,0));return i.times(e.w).minus(e.times(i.w)).div(Math.pow(e.w,2)).V3()}transformedPoints(t){return t.map((t=>this.transformPoint(t)))}transformedVectors(t){return t.map((t=>this.transformVector(t)))}new(){return new it}isRegular(){return!y(this.determinant())}isAxisAligned(){const t=this.m;return 1>=+!y(t[0])+ +!y(t[1])+ +!y(t[2])&&1>=+!y(t[4])+ +!y(t[5])+ +!y(t[6])&&1>=+!y(t[8])+ +!y(t[9])+ +!y(t[10])}isOrthogonal(){return it.transpose(this,it.temp0),it.multiply(this,it.temp0,it.temp1),it.IDENTITY.likeM4(it.temp1)}isSymmetric(){return it.transpose(this,it.temp0),this.likeM4(it.temp0)}isSkewSymmetric(t){return y(this.m[0],t)&&y(this.m[5],t)&&y(this.m[10],t)&&y(this.m[15],t)&&g(this.m[1],this.m[4],t)&&g(this.m[2],this.m[8],t)&&g(this.m[3],this.m[12],t)&&g(this.m[6],this.m[9],t)&&g(this.m[7],this.m[13],t)&&g(this.m[11],this.m[14],t)}isNormal(){return it.transpose(this,it.temp0),it.multiply(this,it.temp0,it.temp1),it.multiply(it.temp0,this,it.temp2),it.temp1.likeM4(it.temp2)}determinant(){const t=this.m,r=t[0],e=t[1],i=t[2],n=t[3],s=t[4],h=t[5],o=t[6],a=t[7],l=t[8],u=t[9],c=t[10],m=t[11],f=t[12],d=t[13],y=t[14],g=t[15],w=c*g-m*y,p=u*g-m*d,x=u*y-c*d,M=l*g-m*f,v=l*y-c*f,z=l*d-u*f;return r*(h*w-o*p+a*x)-e*(s*w-o*M+a*v)+i*(s*p-h*M+a*z)-n*(s*x-h*v+o*z)}determinant3(){const[t,r,e,,i,n,s,,h,o,a]=this.m;return t*(n*a-s*o)-r*(i*a-s*h)+e*(i*o-n*h)}isMirroring(){return this.determinant()<0}getTranslation(){const t=this.m,r=t[15];return new B(t[3]/r,t[7]/r,t[11]/r)}normalized(){const t=et(this.determinant());return 1==t?this:this.divScalar(Math.pow(t,.25))}normalized2(){const t=this.m[15];return 1==t?this:this.divScalar(Math.pow(t,.25))}like3x3(){const t=this.m;return g(1,t[15])&&y(t[12])&&y(t[13])&&y(t[14])&&y(t[3])&&y(t[7])&&y(t[11])}isNoProj(){const t=this.m;return 0==t[12]&&0==t[13]&&0==t[14]&&1==t[15]}likeIdentity(){return this.m.every(((t,r)=>(r/4|0)==r%4?g(1,t):y(t)))}isIdentity(){return this.m.every(((t,r)=>(r/4|0)==r%4?1==t:0==t))}toString(t=(t=>t.toFixed(6).replace(/([0.])(?=0*$)/g," "))){c("string"==typeof t(0),typeof t(0));const r=Array.prototype.slice.call(this.m).map(t),e=[0,1,2,3].map((t=>Y(function(t,r,e,i,n=1){l(r,i),r<0&&(r=t.length+r),e<=0&&(e=t.length+e);const s=Math.ceil((e-r)/i),h=Array(s);let o=0;for(let s=r;s<e;s+=i)for(let r=s;r<Math.min(s+n,e);r++)h[o++]=t[r];return c(s==o),h}(r,t,0,4).map((t=>t.length)))));return[0,1,2,3].map((t=>r.slice(4*t,4*t+4).map(((t,r)=>" ".repeat(e[r]-t.length)+t)).join(" "))).join("\n")}isTranslation(){return[1,0,0,2,0,1,0,2,0,0,1,2,0,0,0,1].every(((t,r)=>2==t||t==this.m[r]))}isScaling(){return[2,0,0,0,0,2,0,0,0,0,2,0,0,0,0,1].every(((t,r)=>2==t||t==this.m[r]))}isZRotation(){return[2,2,0,0,2,2,0,0,0,0,1,0,0,0,0,1].every(((t,r)=>2==t||t==this.m[r]))&&g(1,Math.pow(this.m[0],2)+Math.pow(this.m[1],2))&&this.m[0]==this.m[5]&&this.m[1]==-this.m[4]}toSource(){const t=it.NAMEMAP.get(this);if(t)return t;if(this.isTranslation())return E("M4.translate",this.O);if(this.isScaling())return E("M4.scale",this.m[0],this.m[5],this.m[10]);if(this.isNoProj())return this.O.equals(B.O)?E("M4.forSys",this.X,this.Y,this.Z):E("M4.forSys",this.X,this.Y,this.Z,this.O);if(this.isMirror(0)){const t=this.m,r=Math.sqrt((1-t[0])/2),e=Math.sqrt((1-t[5])/2),i=Math.sqrt((1-t[10])/2),n=t[3]/2/r;return E("M4.mirror",{normal1:new B(r,e,i),w:n})}{const t=this.m;return"new M4(\n\t"+t[0]+",\t"+t[1]+",\t"+t[2]+",\t"+t[3]+",\n\t"+t[4]+",\t"+t[5]+",\t"+t[6]+",\t"+t[7]+",\n\t"+t[8]+",\t"+t[9]+",\t"+t[10]+",\t"+t[11]+",\n\t"+t[12]+",\t"+t[13]+",\t"+t[14]+",\t"+t[15]+")"}}xyAreaFactor(){return this.transformVector(B.X).cross(this.transformVector(B.Y)).length()}}it.FOO=new it(0,1,1,2,.3,.4,.8,13,2.1,3.4,5.5,8.9,0,0,0,1),it.BAR=it.FOO.inversed(),it.IDENTITY=it.identity(),it.O=new it(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),it.YZX=it.forSys(B.Y,B.Z,B.X),it.ZXY=it.forSys(B.Z,B.X,B.Y),it.IDENTITY3=new it(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0),it.temp0=new it,it.temp1=new it,it.temp2=new it,it.NAMEMAP=(new i).set(it.IDENTITY3,"M4.IDENTITY3").set(it.FOO,"M4.FOO").set(it.O,"M4.O").set(it.BAR,"M4.BAR").set(it.IDENTITY,"M4.IDENTITY").set(it.ZXY,"M4.ZXY").set(it.YZX,"M4.YZX"),it.prototype.height=4,it.prototype.width=4,z(it.prototype,H.prototype,"constructor")}}]);